// set up of ports
const int firePinIn = A0; // Normally 800
const int rhSensPinIn = A1; // Normally 90
const int gasSensPinIn = A2; // Normally 60
const int movementPinInTrig = A3; //
const int movementPinInEcho = A4; //


const int alarmPinOut = 0; //
const int lockPinOut = 1; //
const int safetyPinOut = 2; //
const int gasFanPinOutINA = 10;
const int gasFanPinOutINB = 11; //
const int exhaustFanPinOutINA = 8; //
const int exhaustFanPinOutINB = 9; 

//Inputs for SCADA

const int fireStatus = 5; //D5 on leo -> D5 on nano
//const int gasFanStatus = 3;
//const int exhaustFanStatus = ;
//const int lockLedStatus = ;
const int movementStatus = 4; //D4 on leo -> D4 on nano

//const int rhSensStatus = ;
//const int gasSensStatus = ;


// set up variables
// boolean sensTempIn = false; 
// boolean sensCOIn = false;  
// boolean moveInRoom = false; 
// boolean alarmOn = false; 
// boolean lockDoor = false; 

boolean fireExtinguished = false;
int i = 0;

void setup() {
  // put your setup code here, to run once:
  //analog in
  pinMode(firePinIn, INPUT);
  pinMode(rhSensPinIn, INPUT);
  pinMode(gasSensPinIn, INPUT);
  pinMode(movementPinInTrig, INPUT);
  pinMode(fireStatus, OUTPUT);
  pinMode(movementStatus, OUTPUT);

  //digital out
  pinMode(alarmPinOut, OUTPUT);
  pinMode(lockPinOut, OUTPUT);
  pinMode(safetyPinOut, OUTPUT);
  pinMode(gasFanPinOutINA, OUTPUT);
  pinMode(gasFanPinOutINB, OUTPUT);
  pinMode(exhaustFanPinOutINA, OUTPUT);
  pinMode(exhaustFanPinOutINB, OUTPUT);

  digitalWrite(alarmPinOut, LOW);
  digitalWrite(lockPinOut, LOW);
  digitalWrite(safetyPinOut, HIGH);
  digitalWrite(gasFanPinOutINA, HIGH);
  digitalWrite(gasFanPinOutINB, HIGH);
  digitalWrite(exhaustFanPinOutINA, LOW);
  digitalWrite(exhaustFanPinOutINB, LOW);
  digitalWrite(fireStatus, LOW);
  digitalWrite(movementStatus, LOW);

}

void loop() {


  setup();
  Serial.println("Setup Done.");
  /*bool tmp = false;
  if(!tmp){
    delay(5000);
    tmp = true;  
  }*/
  
  
 if (!fireExtinguished)
 {
    Serial.println("Inside First If");
    Serial.println("CO Sensor:" + String(analogRead(rhSensPinIn)));
    Serial.println("Gas Sensor:" + String(analogRead(gasSensPinIn)));
    Serial.println("Fire Sensor:" + String(analogRead(firePinIn)));

    if (int(analogRead(firePinIn)) < 800) // if flame
    {
      Serial.println("Fire Detected");
      Serial.println("Fire Sens:" + String(analogRead(firePinIn)));

      delay(3000); // wait for 10 sec

      Serial.println("CO Sensor:" + String(analogRead(rhSensPinIn)));

      if (int(analogRead(firePinIn)) < 800) { // && int(analogRead(rhSensPinIn)) > 50){

        Serial.println("Fire and Smoke Detected");
        digitalWrite(fireStatus, HIGH);

        digitalWrite(alarmPinOut, HIGH);
        digitalWrite(alarmPinOut, HIGH);
        digitalWrite(safetyPinOut, LOW);
        delay(2000);

        int timeChecker = 0;

        Serial.println("Detecting movement");

        while (timeChecker < 5) { // while there is motion inside we should wait
          if (analogRead(movementPinInTrig) > 50) {

            //Serial.println("Yes, there is the move inside. Wait for 20 seconds");
            //delay(200);
            timeChecker = 100;
            digitalWrite(movementStatus, HIGH);
          }
          timeChecker++;
          delay(2000);
        }

        Serial.println("No movement detected. Releasing Inergen gas. Turn pump on");
        digitalWrite(movementStatus, LOW);
        
        digitalWrite(gasFanPinOutINB, HIGH); // release gas inside
        digitalWrite(gasFanPinOutINA, LOW);
        delay(5000); // wait 10 sec while gas occupy all room


        digitalWrite(gasFanPinOutINB, LOW); // stop releasing Gas
        digitalWrite(gasFanPinOutINA, LOW);

        Serial.println("Gas released. Fire suppressed. Turn pump off.");

        delay(5000); // wait when fire stops

        digitalWrite(fireStatus, LOW);
        Serial.println("Turning on Exhaust");


        digitalWrite(exhaustFanPinOutINB, LOW); // exhaust gas out of room
        digitalWrite(exhaustFanPinOutINA, HIGH);

        delay(5000);
        //while(analogRead(gasSensPinIn) > 200){ //  should be analogRead(rhSensPinIn)
         // delay(200); // wait for 5 sec
         // }

        while (analogRead(firePinIn) < 800)
        {
          delay(2000);
        }

        Serial.println("Gas exhausted. Turning off exhaust");
        delay(2000);

        digitalWrite(exhaustFanPinOutINB, LOW); // // turn off motors for exhausting
        digitalWrite(exhaustFanPinOutINA, LOW);

        int i = 0;
        digitalWrite(safetyPinOut, LOW);// anyway should be opened due to CO gone away

        Serial.println("Checking for flame inside");
        delay(2000);

        while (analogRead(firePinIn) < 800) { // if fire still inside alarm cannot be turn off  // should be  analogRead(tempSensPinIn)

          Serial.println("Fire still present");
          digitalWrite(fireStatus, HIGH);
          digitalWrite(safetyPinOut, LOW);
          delay(2000);

          delay(500);
          i++;// wait 5sec fire should gone away
          if (i > 10 ) break;
        }
        digitalWrite(alarmPinOut, LOW);// no fire inside we can turn alarm off
        digitalWrite(fireStatus, LOW);
        digitalWrite(safetyPinOut, HIGH);
        fireExtinguished = true;
      }
    }
 
  }
 delay(1000);  // wait for 10 sec
  
}